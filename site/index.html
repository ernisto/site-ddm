
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.44">
    
    
      
        <title>Trabalho de DDM</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.0253249f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fazendo-seu-proprio-parser" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Trabalho de DDM" class="md-header__button md-logo" aria-label="Trabalho de DDM" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Trabalho de DDM
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Fazendo seu próprio parser
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Trabalho de DDM" class="md-nav__button md-logo" aria-label="Trabalho de DDM" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Trabalho de DDM
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Fazendo seu próprio parser
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Fazendo seu próprio parser
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#abstracoes-divisoes-do-programa" class="md-nav__link">
    <span class="md-ellipsis">
      Abstrações (divisões do programa)
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#abstracoes-divisoes-do-programa" class="md-nav__link">
    <span class="md-ellipsis">
      Abstrações (divisões do programa)
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="fazendo-seu-proprio-parser">Fazendo seu próprio parser</h1>
<p>Parsers são programas responsáveis por transformar um texto (que seguir uma gramatica) em uma estrutura de dado mais fácil de trabalhar. São comuns em ferramentas de linguagem de programação, como compiladores, interpretadores, e até mais comumente para transformar em um hash map, ou dicionário manipulável o seu JSON, YAML, XML, etc.
Aqui será mostrado como fazer um parser tipicamente de uma linguagem de programação, usando a linguagem <a href="https://github.com/luau-lang/luau">Luau</a>, uma linguagem de programação de scripting simples, rápida e tipada, derivada da linguagem <a href="https://www.lua.org/">Lua</a>.</p>
<h2 id="abstracoes-divisoes-do-programa">Abstrações (divisões do programa)</h2>
<p>Parsers de linguagens de programação, diferente de arquivos de configuração simples, são normalmente divididas em algumas etapas, tanto por desempenho, quanto para fornecer mais recursos para os compiladores e interpretadores.</p>
<ol>
<li>O <strong>Lexer</strong>, que será responsável por ler todo o texto, e transformar vários pedacinhos desses textos em <strong>Tokens</strong> (lexing), que geralmente vai ser um pequeno objeto que guarda seu tipo, e opcionalmente vai guardar algumas outras informações úteis, como o texto cru do <strong>Token</strong>, e posição onde o <strong>Token</strong> foi encontrado.<ul>
<li><strong>Tokens</strong> são pequenos pedaços do texto, eles são usados pelo <strong>Parser</strong> para discernir pequenos pedaços de texto mais eficientemente, invés de sempre fazer lexing em contextos possivelmente errados, o que resultara no lexing sendo feito várias vezes para o mesmo <strong>Token</strong>.</li>
<li>Alguns tipos de <strong>Token</strong>s bem comuns em uma linguagem de programação seriam<ul>
<li><strong>palavras</strong> (como <strong>if</strong>, ou nome das variáveis).</li>
<li><strong>Números</strong> (como <strong>10</strong>, <strong>1.5</strong>, ou <strong>3e+2</strong>).</li>
<li><strong>Strings</strong> (como <strong>"Olá Mundo"</strong>).</li>
</ul>
</li>
</ul>
</li>
<li>O <strong>Token Stream</strong> (corrente/fluxo de <strong>Tokens</strong>), que será a parte do programa responsável por dar o <strong>Token</strong> atual, avançar para o próximo, e ocasionalmente voltar para um anterior. É importante ter um fluxo sequencial dos <strong>Tokens</strong>, porque vamos descartando os tokens já usados, facilitando o trabalho com os tokens restantes.</li>
<li>O próprio <strong>Parser</strong> em si, que será quem vai ler toda a cadeia de <strong>Tokens</strong> para a própria estrutura de dados mais conveniente para você, se for um parser de JSON você vai querer transformar em uma Map, no caso de linguagens de programação, vamos transformar em uma <strong>AST</strong> (<strong>A</strong>bstract <strong>S</strong>yntax <strong>T</strong>ree).<ul>
<li><strong>AST</strong> como uma árvore que tem vários galhos emergidos de outros galhos, árvores na programação também tem esses "galhos", porém são chamados de <strong>Nodes</strong> (nós), onde cada <strong>Node</strong> pode se referir a alguns outros <strong>Nodes</strong>, cada tipo de node vai representar um conjunto de tokens, com esse conjunto você vai aos poucos juntando, e obtendo informações mais detalhadas do código.</li>
<li>Alguns tipos de <strong>Nodes</strong> típicos em uma linguagem de programação são<ul>
<li><strong>Node</strong> de blocos de código, onde guarda vários outros <strong>Nodes</strong> de <strong>Statements</strong>.</li>
<li><strong>Nodes</strong> de <strong>Statements</strong> (instruções), como um.<ul>
<li><strong>Node</strong> para definição de variável, onde guardara o nome da variável, e um <strong>Node</strong> de <strong>Expression</strong> para representar o valor inicial dela.</li>
<li><strong>Node</strong> para um if, que guardaria vários nós possibilidades, onde cada possibilidade teria um <strong>Node</strong> de <strong>Expression</strong> para representar a condição, e outro de bloco, para as instruções executadas caso a condição seja verdadeira.</li>
</ul>
</li>
<li><strong>Nodes</strong> de <strong>Expressions</strong> (expressões), que representam valores primitivos, ou operações de outras expressões.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="mao-na-massa">Mão na massa</h1>
<p>Primeiro vamos começar definindo os tipos de tokens
<div class="language-lua highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nb">type</span> <span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">x</span><span class="p">:</span> <span class="n">number</span><span class="p">,</span> <span class="c1">-- coluna dentro da linha atual</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">y</span><span class="p">:</span> <span class="n">number</span><span class="p">,</span>  <span class="c1">-- linha do código fonte</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">z</span><span class="p">:</span> <span class="n">number</span>  <span class="c1">-- coluna absoluta, sendo somada com a coluna das outras linhas</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">}</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="nb">type</span> <span class="n">Token</span> <span class="o">=</span> <span class="n">NumberToken</span> <span class="o">|</span> <span class="n">StringToken</span> <span class="o">|</span> <span class="n">WordToken</span> <span class="o">|</span> <span class="n">CharToken</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="nb">type</span> <span class="n">baseToken</span> <span class="o">=</span> <span class="p">{</span> <span class="c1">-- tipo base para os outros tipos de tokens, com dados que todos terao</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">start</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">final</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">trivia</span><span class="p">:</span> <span class="n">string</span>  <span class="c1">-- espaços em branco após o token</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="p">}</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="nb">type</span> <span class="n">StringToken</span> <span class="o">=</span> <span class="n">baseToken</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="n">kind</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">string</span> <span class="p">}</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="nb">type</span> <span class="n">NumberToken</span> <span class="o">=</span> <span class="n">baseToken</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="n">kind</span><span class="p">:</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">number</span> <span class="p">}</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="nb">type</span> <span class="n">WordToken</span> <span class="o">=</span> <span class="n">baseToken</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="n">kind</span><span class="p">:</span> <span class="s1">&#39;word&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="n">string</span> <span class="p">}</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="nb">type</span> <span class="n">CharToken</span> <span class="o">=</span> <span class="n">baseToken</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="n">kind</span><span class="p">:</span> <span class="s1">&#39;char&#39;</span><span class="p">,</span> <span class="n">char</span><span class="p">:</span> <span class="n">string</span> <span class="p">}</span>
</span></code></pre></div>
E então vamos começar com o lexer, como um tutorial introdutório, vai ser uma implementação simples, porém lerda (ainda mais por estarmos usando uma linguagem de alto nível) porém vai ser suficiente para entender os fundamentos.
<div class="language-lua highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">-- context</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kd">local</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kd">local</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="kd">local</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span>    <span class="c1">-- posicao inicial da string que estamos lendo</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kd">local</span> <span class="n">pos</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="p">}</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="kd">local</span> <span class="n">tokens</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="c1">-- redefine estados globais do modulo</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="c1">-- pode ocassionar bugs se fizer isso, antes de terminar de usar os estados anteriores</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">lex</span><span class="p">(</span><span class="n">sourceCode</span><span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">Token</span><span class="p">}</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>    <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span>    <span class="c1">-- posicao inicial da string que estamos lendo</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>    <span class="n">pos</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="p">}</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    <span class="n">tokens</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="kr">end</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="c1">-- futuramente podemos incluir gramatica de comentários aqui</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">scanTrivia</span><span class="p">():</span> <span class="n">string</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>    <span class="kd">local</span> <span class="n">trivias</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>    <span class="kd">local</span> <span class="n">_</span><span class="p">,</span><span class="n">final</span><span class="p">,</span> <span class="n">trivia</span> <span class="o">=</span> <span class="nb">string.find</span><span class="p">(</span><span class="n">sourceCode</span><span class="p">,</span> <span class="s2">&quot;^([ </span><span class="se">\t</span><span class="s2">]*)&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>    <span class="kr">if</span> <span class="n">final</span> <span class="kr">then</span> <span class="nb">table.insert</span><span class="p">(</span><span class="n">trivias</span><span class="p">,</span> <span class="n">trivia</span><span class="p">);</span> <span class="n">z</span> <span class="o">=</span> <span class="n">final</span><span class="o">+</span><span class="mi">1</span> <span class="kr">end</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>    <span class="kr">while</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">sourceCode</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="kr">do</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>        <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>        <span class="n">y</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>        <span class="n">z</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>        <span class="n">_</span><span class="p">,</span><span class="n">final</span><span class="p">,</span> <span class="n">trivia</span> <span class="o">=</span> <span class="nb">string.find</span><span class="p">(</span><span class="n">sourceCode</span><span class="p">,</span> <span class="s2">&quot;^([ </span><span class="se">\t</span><span class="s2">]*)&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>        <span class="kr">if</span> <span class="n">final</span> <span class="kr">then</span> <span class="nb">table.insert</span><span class="p">(</span><span class="n">trivias</span><span class="p">,</span> <span class="n">trivia</span><span class="p">);</span> <span class="n">z</span> <span class="o">=</span> <span class="n">final</span><span class="o">+</span><span class="mi">1</span> <span class="kr">end</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>    <span class="kr">end</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>    <span class="n">pos</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="p">}</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>    <span class="kr">return</span> <span class="nb">table.concat</span><span class="p">(</span><span class="n">trivias</span><span class="p">)</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="kr">end</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="c1">-- normalmente</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">scanNumber</span><span class="p">():</span> <span class="n">NumberToken</span><span class="err">?</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>    <span class="kd">local</span> <span class="n">start</span> <span class="o">=</span> <span class="n">pos</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>    <span class="kd">local</span> <span class="n">_</span><span class="p">,</span><span class="n">final</span><span class="p">,</span> <span class="n">decimal</span> <span class="o">=</span> <span class="nb">string.find</span><span class="p">(</span><span class="n">sourceCode</span><span class="p">,</span> <span class="s2">&quot;^(%d+)&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>    <span class="kr">if</span> <span class="n">decimal</span> <span class="kr">then</span> <span class="n">z</span> <span class="o">=</span> <span class="n">final</span><span class="o">+</span><span class="mi">1</span> <span class="kr">end</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>    <span class="kd">local</span> <span class="n">_</span><span class="p">,</span><span class="n">final</span><span class="p">,</span> <span class="n">fractional</span> <span class="o">=</span> <span class="nb">string.find</span><span class="p">(</span><span class="n">sourceCode</span><span class="p">,</span> <span class="s2">&quot;^%.(%d+)&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>    <span class="kr">if</span> <span class="n">fractional</span> <span class="kr">then</span> <span class="n">z</span> <span class="o">=</span> <span class="n">final</span><span class="o">+</span><span class="mi">1</span> <span class="kr">end</span>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>    <span class="kr">if</span> <span class="ow">not</span> <span class="n">decimal</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fractional</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kr">end</span>  <span class="c1">-- aqui ja desconsideramos esse token como um número</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>    <span class="kd">local</span> <span class="n">final</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">final</span> <span class="p">}</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>    <span class="kr">return</span> <span class="p">{</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>        <span class="n">final</span> <span class="o">=</span> <span class="n">final</span><span class="p">,</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a>        <span class="n">trivia</span> <span class="o">=</span> <span class="n">scanTrivia</span><span class="p">(),</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>        <span class="n">decimal</span> <span class="o">=</span> <span class="n">decimal</span><span class="p">,</span>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>        <span class="n">fractional</span> <span class="o">=</span> <span class="n">fractional</span><span class="p">,</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>        <span class="n">exponent</span> <span class="o">=</span> <span class="n">exponent</span><span class="p">,</span>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>        <span class="n">expSign</span> <span class="o">=</span> <span class="n">sign</span><span class="p">,</span>
</span><span id="__span-1-62"><a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a>    <span class="p">}</span>
</span><span id="__span-1-63"><a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a><span class="kr">end</span>
</span><span id="__span-1-64"><a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">scanString</span><span class="p">():</span> <span class="n">StringToken</span><span class="err">?</span>
</span><span id="__span-1-65"><a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a>
</span><span id="__span-1-66"><a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>    <span class="kd">local</span> <span class="n">start</span> <span class="o">=</span> <span class="n">pos</span>
</span><span id="__span-1-67"><a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a>
</span><span id="__span-1-68"><a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a>    <span class="kd">local</span> <span class="n">_</span><span class="p">,</span><span class="n">final</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="nb">string.find</span><span class="p">(</span><span class="n">sourceCode</span><span class="p">,</span> <span class="s2">&quot;^(%b</span><span class="se">\&quot;\&quot;</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="__span-1-69"><a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a>    <span class="kr">if</span> <span class="ow">not</span> <span class="n">final</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kr">end</span>
</span><span id="__span-1-70"><a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a>    <span class="n">z</span> <span class="o">=</span> <span class="n">final</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="__span-1-71"><a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a>
</span><span id="__span-1-72"><a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>    <span class="kd">local</span> <span class="n">final</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">final</span> <span class="p">}</span>
</span><span id="__span-1-73"><a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a>    <span class="kr">return</span> <span class="p">{</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;string&#39;</span>
</span><span id="__span-1-74"><a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span>
</span><span id="__span-1-75"><a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a>        <span class="n">final</span> <span class="o">=</span> <span class="n">final</span><span class="p">,</span>
</span><span id="__span-1-76"><a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a>        <span class="n">trivia</span> <span class="o">=</span> <span class="n">scanTrivia</span><span class="p">(),</span>
</span><span id="__span-1-77"><a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a>        <span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="__span-1-78"><a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>    <span class="p">}</span>
</span><span id="__span-1-79"><a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a><span class="kr">end</span>
</span><span id="__span-1-80"><a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">scanWord</span><span class="p">():</span> <span class="n">WordToken</span><span class="err">?</span>
</span><span id="__span-1-81"><a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a>
</span><span id="__span-1-82"><a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a>    <span class="kd">local</span> <span class="n">start</span> <span class="o">=</span> <span class="n">pos</span>
</span><span id="__span-1-83"><a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a>    <span class="kd">local</span> <span class="n">_</span><span class="p">,</span><span class="n">final</span><span class="p">,</span> <span class="n">word</span> <span class="o">=</span> <span class="nb">string.find</span><span class="p">(</span><span class="n">sourceCode</span><span class="p">,</span> <span class="s2">&quot;^(%w+)&quot;</span><span class="p">)</span>
</span><span id="__span-1-84"><a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a>    <span class="kr">if</span> <span class="ow">not</span> <span class="n">final</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kr">end</span>
</span><span id="__span-1-85"><a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a>
</span><span id="__span-1-86"><a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a>    <span class="n">z</span> <span class="o">=</span> <span class="n">final</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="__span-1-87"><a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a>
</span><span id="__span-1-88"><a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a>    <span class="kd">local</span> <span class="n">final</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">final</span> <span class="p">}</span>
</span><span id="__span-1-89"><a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a>    <span class="kr">return</span> <span class="p">{</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;word&#39;</span><span class="p">,</span>
</span><span id="__span-1-90"><a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span>
</span><span id="__span-1-91"><a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a>        <span class="n">final</span> <span class="o">=</span> <span class="n">final</span><span class="p">,</span>
</span><span id="__span-1-92"><a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a>        <span class="n">trivia</span> <span class="o">=</span> <span class="n">scanTrivia</span><span class="p">(),</span>
</span><span id="__span-1-93"><a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a>        <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="p">,</span>
</span><span id="__span-1-94"><a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a>    <span class="p">}</span>
</span><span id="__span-1-95"><a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a><span class="kr">end</span>
</span><span id="__span-1-96"><a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">scanChar</span><span class="p">():</span> <span class="n">Token</span>
</span><span id="__span-1-97"><a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a>
</span><span id="__span-1-98"><a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a>    <span class="kd">local</span> <span class="n">start</span> <span class="o">=</span> <span class="n">pos</span>
</span><span id="__span-1-99"><a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a>    <span class="kd">local</span> <span class="n">_</span><span class="p">,</span><span class="n">final</span><span class="p">,</span> <span class="n">char</span> <span class="o">=</span> <span class="nb">string.find</span><span class="p">(</span><span class="n">sourceCode</span><span class="p">,</span> <span class="s2">&quot;^(.)&quot;</span><span class="p">)</span>
</span><span id="__span-1-100"><a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a>    <span class="n">z</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-1-101"><a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a>
</span><span id="__span-1-102"><a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a>    <span class="kd">local</span> <span class="n">final</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">final</span> <span class="p">}</span>
</span><span id="__span-1-103"><a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a>    <span class="kr">return</span> <span class="p">{</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;char&#39;</span><span class="p">,</span>
</span><span id="__span-1-104"><a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span>
</span><span id="__span-1-105"><a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a>        <span class="n">final</span> <span class="o">=</span> <span class="n">final</span><span class="p">,</span>
</span><span id="__span-1-106"><a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a>        <span class="n">trivia</span> <span class="o">=</span> <span class="n">scanTrivia</span><span class="p">(),</span>
</span><span id="__span-1-107"><a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a>        <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="p">,</span>
</span><span id="__span-1-108"><a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a>    <span class="p">}</span>
</span><span id="__span-1-109"><a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a><span class="kr">end</span>
</span><span id="__span-1-110"><a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">scanToken</span><span class="p">()</span>
</span><span id="__span-1-111"><a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a>    <span class="kr">return</span> <span class="n">scanNumber</span><span class="p">()</span>
</span><span id="__span-1-112"><a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a>        <span class="ow">or</span> <span class="n">scanString</span><span class="p">()</span>
</span><span id="__span-1-113"><a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a>        <span class="ow">or</span> <span class="n">scanWord</span><span class="p">()</span>
</span><span id="__span-1-114"><a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a>        <span class="ow">or</span> <span class="n">scanChar</span><span class="p">()</span>
</span><span id="__span-1-115"><a id="__codelineno-1-115" name="__codelineno-1-115" href="#__codelineno-1-115"></a><span class="kr">end</span>
</span></code></pre></div>
Após ter feito o <strong>Lexer</strong>, vamos tokenizar tudo de uma vez, e expor alguns métodos para consumir os tokens desde o início, descartando os anteriores
<div class="language-lua highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kd">local</span> <span class="n">tokens</span><span class="p">:</span> <span class="p">{</span><span class="n">Token</span><span class="p">}</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kd">local</span> <span class="n">cursor</span><span class="p">:</span> <span class="n">number</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kd">local</span> <span class="n">token</span><span class="p">:</span> <span class="n">Token</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">tokenizeAll</span><span class="p">(</span><span class="n">_sourceCode</span><span class="p">:</span> <span class="n">string</span><span class="p">)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="n">lex</span><span class="p">(</span><span class="n">_sourceCode</span><span class="p">)</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="n">tokens</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="kr">repeat</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>        <span class="kd">local</span> <span class="n">token</span> <span class="o">=</span> <span class="n">scanToken</span><span class="p">()</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>        <span class="kr">if</span> <span class="n">token</span> <span class="kr">then</span> <span class="nb">table.insert</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span> <span class="kr">end</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="kr">until</span> <span class="ow">not</span> <span class="n">token</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>    <span class="n">token</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="kr">end</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">consume</span><span class="p">():</span> <span class="n">Token</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>    <span class="kd">local</span> <span class="n">last</span> <span class="o">=</span> <span class="n">token</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>    <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>    <span class="n">token</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>    <span class="kr">return</span> <span class="n">last</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="kr">end</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="c1">-- uma das razões para tokenizar tudo primeiro, é para não ter que re-tokenizar o mesmo</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="c1">-- token Word por não atender a diferentes exigencias do parametro &#39;specific&#39; que vão aparecer conforme o parsing de um arquivo inteiro</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">consumeWord</span><span class="p">(</span><span class="n">specific</span><span class="p">:</span> <span class="n">string</span><span class="err">?</span><span class="p">):</span> <span class="n">WordToken</span><span class="err">?</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>    <span class="kr">return</span> <span class="kr">if</span> <span class="n">token</span> <span class="ow">and</span> <span class="n">token</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;word&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">specific</span> <span class="ow">or</span> <span class="n">token</span><span class="p">.</span><span class="n">text</span> <span class="o">==</span> <span class="n">specific</span><span class="p">)</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>        <span class="kr">then</span> <span class="n">consume</span><span class="p">()</span> <span class="p">::</span> <span class="nl">any</span> <span class="nl">else</span> <span class="nl">nil</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="nl">end</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="nl">local</span> <span class="nl">function</span> <span class="nl">consumeChar</span><span class="err">(</span><span class="nl">specific</span><span class="err">:</span> <span class="nl">string</span><span class="err">?):</span> <span class="nl">CharToken</span><span class="err">?</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>    <span class="nl">return</span> <span class="nl">if</span> <span class="nl">token</span> <span class="nl">and</span> <span class="nl">token</span><span class="err">.</span><span class="nl">kind</span> <span class="err">==</span> <span class="err">&#39;</span><span class="nl">char</span><span class="err">&#39;</span> <span class="nl">and</span> <span class="err">(</span><span class="nl">not</span> <span class="nl">specific</span> <span class="nl">or</span> <span class="nl">token</span><span class="err">.</span><span class="nl">char</span> <span class="err">==</span> <span class="nl">specific</span><span class="err">)</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>        <span class="nl">then</span> <span class="nl">consume</span><span class="err">()</span> <span class="p">::</span> <span class="n">any</span> <span class="kr">else</span> <span class="kc">nil</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="kr">end</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">consumeNum</span><span class="p">():</span> <span class="n">NumberToken</span><span class="err">?</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>    <span class="kr">return</span> <span class="kr">if</span> <span class="n">token</span> <span class="ow">and</span> <span class="n">token</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;number&#39;</span> <span class="kr">then</span> <span class="n">consume</span><span class="p">()</span> <span class="p">::</span> <span class="nl">any</span> <span class="nl">else</span> <span class="nl">nil</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="nl">end</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="nl">local</span> <span class="nl">function</span> <span class="nl">consumeStr</span><span class="err">():</span> <span class="nl">StringToken</span><span class="err">?</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>    <span class="nl">return</span> <span class="nl">if</span> <span class="nl">token</span> <span class="nl">and</span> <span class="nl">token</span><span class="err">.</span><span class="nl">kind</span> <span class="err">==</span> <span class="err">&#39;</span><span class="nl">string</span><span class="err">&#39;</span> <span class="nl">then</span> <span class="nl">consume</span><span class="err">()</span> <span class="p">::</span> <span class="n">any</span> <span class="kr">else</span> <span class="kc">nil</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="kr">end</span>
</span></code></pre></div>
Após ter feito o <strong>Lexer</strong>, vamos escrever o <strong>Token Stream</strong>, que usará o <strong>Lexer</strong> para gerar uma <strong>AST</strong> do código recebido, usando os <strong>Tokens</strong> definidos previamente.
vamos definir os tipos de <strong>Nodes</strong>(nós) que teremos na nossa gramática
<div class="language-lua highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nb">type</span> <span class="n">block</span> <span class="o">=</span> <span class="p">{</span> <span class="n">kind</span><span class="p">:</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="n">stats</span><span class="p">:</span> <span class="p">{</span><span class="n">stat</span><span class="p">}</span> <span class="p">}</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nb">type</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">assignment</span> <span class="o">|</span> <span class="n">callment</span> <span class="o">|</span> <span class="n">if_stat</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nb">type</span> <span class="n">assignment</span> <span class="o">=</span> <span class="p">{</span> <span class="n">kind</span><span class="p">:</span> <span class="s1">&#39;assignment&#39;</span><span class="p">,</span> <span class="n">targetName</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">expr</span> <span class="p">}</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="nb">type</span> <span class="n">callment</span> <span class="o">=</span> <span class="p">{</span> <span class="n">kind</span><span class="p">:</span> <span class="s1">&#39;callment&#39;</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">{</span><span class="n">expr</span><span class="p">}</span> <span class="p">}</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="nb">type</span> <span class="n">if_stat</span> <span class="o">=</span> <span class="p">{</span> <span class="n">kind</span><span class="p">:</span> <span class="s1">&#39;if&#39;</span><span class="p">,</span> <span class="n">cond</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span> <span class="n">then_body</span><span class="p">:</span> <span class="n">block</span><span class="p">,</span> <span class="n">else_body</span><span class="p">:</span> <span class="n">block</span><span class="err">?</span> <span class="p">}</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="nb">type</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">str_expr</span> <span class="o">|</span> <span class="n">num_expr</span> <span class="o">|</span> <span class="n">read_expr</span> <span class="o">|</span> <span class="n">biop_expr</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="nb">type</span> <span class="n">str_expr</span> <span class="o">=</span> <span class="p">{</span> <span class="n">kind</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="n">str</span><span class="p">:</span> <span class="n">StringToken</span> <span class="p">}</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="nb">type</span> <span class="n">num_expr</span> <span class="o">=</span> <span class="p">{</span> <span class="n">kind</span><span class="p">:</span> <span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="n">NumberToken</span> <span class="p">}</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="nb">type</span> <span class="n">read_expr</span> <span class="o">=</span> <span class="p">{</span> <span class="n">kind</span><span class="p">:</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">WordToken</span> <span class="p">}</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="nb">type</span> <span class="n">biop_expr</span> <span class="o">=</span> <span class="p">{</span> <span class="n">kind</span><span class="p">:</span> <span class="s1">&#39;biop&#39;</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span> <span class="n">expr</span> <span class="p">}</span>
</span></code></pre></div></p>
<p>E então, vamos implementar o parser de fato. Vale notar que existe várias estratégias de implementação, mas o parser implementado aqui é um parser <strong>LL</strong> (<strong>L</strong>eft-to-right <strong>L</strong>eft-must), descendente e recursivo ser combinar pequenas funções em funções maiores. Esse tipo de estratégia é a forma mais simples, e flexível de se implementar.
<div class="language-lua highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kd">local</span> <span class="n">parse_body</span><span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">block</span><span class="err">?</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">token_to_str</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="n">Token</span><span class="p">)</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    <span class="kr">return</span> <span class="kr">if</span> <span class="n">token</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;word&#39;</span> <span class="kr">then</span> <span class="n">token</span><span class="p">.</span><span class="n">text</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>        <span class="kr">elseif</span> <span class="n">token</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;char&#39;</span> <span class="kr">then</span> <span class="n">token</span><span class="p">.</span><span class="n">char</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>        <span class="kr">elseif</span> <span class="n">token</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span> <span class="kr">then</span> <span class="n">token</span><span class="p">.</span><span class="n">content</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        <span class="kr">else</span> <span class="nb">tostring</span><span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="kr">end</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">parsing_error</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">string</span><span class="p">):</span> <span class="n">never</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="nb">error</span><span class="p">(</span><span class="err">`</span><span class="n">erro</span> <span class="n">em</span> <span class="p">{</span><span class="n">token</span><span class="p">.</span><span class="n">start</span><span class="p">.</span><span class="n">y</span><span class="p">}:{</span><span class="n">token</span><span class="p">.</span><span class="n">start</span><span class="p">.</span><span class="n">x</span><span class="p">}:</span><span class="err">\</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="p">{</span><span class="n">message</span><span class="p">}</span> <span class="p">(</span><span class="n">recebido</span><span class="p">:</span> <span class="s1">&#39;{token_to_str(token)}&#39;</span><span class="p">)</span><span class="err">`</span><span class="p">)</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="kr">end</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="c1">-- expr</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="c1">-- aqui é importante a configuração de precedencia e associatividade de cada operador</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="kd">local</span> <span class="n">LEVEL</span> <span class="o">=</span> <span class="p">{</span>     <span class="c1">-- todos os operadores: left-associative: ex: ((1 + 2) + 3) + 4</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="p">[</span><span class="s1">&#39;&lt;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="p">[</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="p">[</span><span class="s1">&#39;&gt;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>    <span class="p">[</span><span class="s1">&#39;&gt;=&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>    <span class="p">[</span><span class="s1">&#39;==&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>    <span class="p">[</span><span class="s1">&#39;!=&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>    <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>    <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>    <span class="p">[</span><span class="s1">&#39;/&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>    <span class="p">[</span><span class="s1">&#39;%&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>    <span class="p">[</span><span class="s1">&#39;^&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="c1">-- exceto esse: right-associative, ex: 2^(3^(4^5))</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a><span class="p">}</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">parse_atom</span><span class="p">():</span> <span class="n">expr</span><span class="err">?</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>    <span class="kd">local</span> <span class="n">str</span> <span class="o">=</span> <span class="n">consumeStr</span><span class="p">()</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>    <span class="kr">if</span> <span class="n">str</span> <span class="kr">then</span> <span class="kr">return</span> <span class="p">{</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="n">str</span> <span class="o">=</span> <span class="n">str</span> <span class="p">}</span> <span class="kr">end</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>    <span class="kd">local</span> <span class="n">num</span> <span class="o">=</span> <span class="n">consumeNum</span><span class="p">()</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>    <span class="kr">if</span> <span class="n">num</span> <span class="kr">then</span> <span class="kr">return</span> <span class="p">{</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">num</span> <span class="p">}</span> <span class="kr">end</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>    <span class="kd">local</span> <span class="n">name</span> <span class="o">=</span> <span class="n">consumeWord</span><span class="p">()</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>    <span class="kr">if</span> <span class="n">name</span> <span class="kr">then</span> <span class="kr">return</span> <span class="p">{</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="p">}</span> <span class="kr">end</span>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>    <span class="kr">return</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a><span class="kr">end</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">parse_expr</span><span class="p">(</span><span class="n">_left</span><span class="p">:</span> <span class="n">expr</span><span class="err">?</span><span class="p">,</span> <span class="n">_currentLevel</span><span class="p">:</span> <span class="n">number</span><span class="err">?</span><span class="p">):</span> <span class="n">expr</span><span class="err">?</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>    <span class="kd">local</span> <span class="n">left</span> <span class="o">=</span> <span class="n">_left</span> <span class="ow">or</span> <span class="n">parse_atom</span><span class="p">()</span>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>    <span class="kr">if</span> <span class="ow">not</span> <span class="n">left</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kr">end</span>
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>    <span class="kd">local</span> <span class="n">currentLevel</span> <span class="o">=</span> <span class="n">_currentLevel</span> <span class="ow">or</span> <span class="mi">0</span>
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>    <span class="kr">repeat</span>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>        <span class="kd">local</span> <span class="n">op</span> <span class="o">=</span> <span class="kr">if</span> <span class="n">token</span> <span class="ow">and</span> <span class="n">token</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;char&#39;</span> <span class="kr">then</span> <span class="n">token</span> <span class="kr">else</span> <span class="kc">nil</span>
</span><span id="__span-4-56"><a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>        <span class="kr">if</span> <span class="ow">not</span> <span class="n">op</span> <span class="kr">then</span> <span class="kr">break</span> <span class="kr">end</span>
</span><span id="__span-4-57"><a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>        <span class="kd">local</span> <span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">.</span><span class="n">char</span>
</span><span id="__span-4-58"><a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>
</span><span id="__span-4-59"><a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>        <span class="kd">local</span> <span class="n">level</span> <span class="o">=</span> <span class="n">LEVEL</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
</span><span id="__span-4-60"><a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>        <span class="kr">if</span> <span class="ow">not</span> <span class="n">level</span> <span class="kr">then</span> <span class="kr">break</span> <span class="kr">end</span> <span class="c1">-- volta o cursor, como se estivesse devolvendo o token consumido</span>
</span><span id="__span-4-61"><a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>
</span><span id="__span-4-62"><a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>        <span class="kr">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="n">currentLevel</span> <span class="kr">then</span> <span class="kr">break</span> <span class="kr">end</span>
</span><span id="__span-4-63"><a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>        <span class="n">consume</span><span class="p">()</span>
</span><span id="__span-4-64"><a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>
</span><span id="__span-4-65"><a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>        <span class="kd">local</span> <span class="n">subParseLevel</span> <span class="o">=</span> <span class="kr">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;^&#39;</span> <span class="kr">then</span> <span class="n">level</span><span class="o">-</span><span class="mi">1</span> <span class="kr">else</span> <span class="n">level</span>  <span class="c1">-- por causa que esse operador em especifico é right-associative</span>
</span><span id="__span-4-66"><a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>        <span class="kd">local</span> <span class="n">right</span> <span class="o">=</span> <span class="n">parse_expr</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">subParseLevel</span><span class="p">)</span>
</span><span id="__span-4-67"><a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>            <span class="ow">or</span> <span class="n">parsing_error</span><span class="p">(</span><span class="err">`</span><span class="n">expressao</span> <span class="n">esperada</span><span class="err">`</span><span class="p">)</span>
</span><span id="__span-4-68"><a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>
</span><span id="__span-4-69"><a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>        <span class="n">left</span> <span class="o">=</span> <span class="p">{</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;biop&#39;</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">right</span> <span class="p">}</span>
</span><span id="__span-4-70"><a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>
</span><span id="__span-4-71"><a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>    <span class="kr">until</span> <span class="kc">false</span>
</span><span id="__span-4-72"><a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>    <span class="kr">return</span> <span class="n">left</span>
</span><span id="__span-4-73"><a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a><span class="kr">end</span>
</span><span id="__span-4-74"><a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>
</span><span id="__span-4-75"><a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a><span class="c1">-- stat</span>
</span><span id="__span-4-76"><a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">parse_assignment</span><span class="p">()</span>
</span><span id="__span-4-77"><a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>
</span><span id="__span-4-78"><a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>    <span class="kr">if</span> <span class="ow">not</span> <span class="n">consumeWord</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">)</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kr">end</span>
</span><span id="__span-4-79"><a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>    <span class="kd">local</span> <span class="n">varName</span> <span class="o">=</span> <span class="n">consumeWord</span><span class="p">()</span>
</span><span id="__span-4-80"><a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a>    <span class="kd">local</span> <span class="n">_1</span> <span class="o">=</span> <span class="n">consumeWord</span><span class="p">(</span><span class="s1">&#39;to&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">parsing_error</span><span class="p">(</span><span class="err">`</span><span class="n">token</span> <span class="s1">&#39;to&#39;</span> <span class="n">esperado</span><span class="err">`</span><span class="p">)</span>
</span><span id="__span-4-81"><a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>    <span class="kd">local</span> <span class="n">value</span> <span class="o">=</span> <span class="n">parse_expr</span><span class="p">()</span>
</span><span id="__span-4-82"><a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a>
</span><span id="__span-4-83"><a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a>    <span class="kr">return</span> <span class="p">{</span>
</span><span id="__span-4-84"><a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a>        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;assignment&#39;</span><span class="p">,</span>
</span><span id="__span-4-85"><a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>        <span class="n">targetName</span> <span class="o">=</span> <span class="n">varName</span><span class="p">,</span>
</span><span id="__span-4-86"><a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a>        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="__span-4-87"><a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a>    <span class="p">}</span>
</span><span id="__span-4-88"><a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a><span class="kr">end</span>
</span><span id="__span-4-89"><a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">parse_callment</span><span class="p">()</span>
</span><span id="__span-4-90"><a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a>
</span><span id="__span-4-91"><a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>    <span class="kd">local</span> <span class="n">func</span> <span class="o">=</span> <span class="n">parse_expr</span><span class="p">()</span>
</span><span id="__span-4-92"><a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a>    <span class="kr">if</span> <span class="ow">not</span> <span class="n">func</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kr">end</span>
</span><span id="__span-4-93"><a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a>
</span><span id="__span-4-94"><a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a>    <span class="kd">local</span> <span class="n">_1</span> <span class="o">=</span> <span class="n">consumeChar</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">parsing_error</span><span class="p">(</span><span class="err">`</span><span class="n">token</span> <span class="s1">&#39;(&#39;</span> <span class="n">esperado</span><span class="err">`</span><span class="p">)</span>
</span><span id="__span-4-95"><a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a>    <span class="kd">local</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> <span class="n">parse_expr</span><span class="p">()</span> <span class="p">}</span>
</span><span id="__span-4-96"><a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a>
</span><span id="__span-4-97"><a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>    <span class="kr">while</span> <span class="n">consumeChar</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="kr">do</span>
</span><span id="__span-4-98"><a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a>
</span><span id="__span-4-99"><a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a>        <span class="kd">local</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">parse_expr</span><span class="p">()</span> <span class="ow">or</span> <span class="n">parsing_error</span><span class="p">(</span><span class="err">`</span><span class="n">argumento</span> <span class="n">depois</span> <span class="n">da</span> <span class="s1">&#39;,&#39;</span> <span class="n">esperado</span><span class="err">`</span><span class="p">)</span>
</span><span id="__span-4-100"><a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>        <span class="nb">table.insert</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</span><span id="__span-4-101"><a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a>    <span class="kr">end</span>
</span><span id="__span-4-102"><a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a>    <span class="kd">local</span> <span class="n">_2</span> <span class="o">=</span> <span class="n">consumeChar</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">parsing_error</span><span class="p">(</span><span class="err">`</span><span class="n">token</span> <span class="s1">&#39;)&#39;</span> <span class="n">esperado</span><span class="err">`</span><span class="p">)</span>
</span><span id="__span-4-103"><a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a>
</span><span id="__span-4-104"><a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a>    <span class="kr">return</span> <span class="p">{</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;callment&#39;</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="p">}</span>
</span><span id="__span-4-105"><a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a><span class="kr">end</span>
</span><span id="__span-4-106"><a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">parse_if</span><span class="p">():</span> <span class="n">if_stat</span><span class="err">?</span>
</span><span id="__span-4-107"><a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a>
</span><span id="__span-4-108"><a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a>    <span class="kr">if</span> <span class="ow">not</span> <span class="n">consumeWord</span><span class="p">(</span><span class="s1">&#39;if&#39;</span><span class="p">)</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kr">end</span>
</span><span id="__span-4-109"><a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a>    <span class="kd">local</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">parse_expr</span><span class="p">()</span> <span class="ow">or</span> <span class="n">parsing_error</span><span class="p">(</span><span class="err">`</span><span class="n">expressao</span> <span class="n">esperada</span><span class="err">`</span><span class="p">)</span>
</span><span id="__span-4-110"><a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a>    <span class="kd">local</span> <span class="n">then_body</span> <span class="o">=</span> <span class="n">parse_body</span><span class="p">()</span> <span class="ow">or</span> <span class="n">parsing_error</span><span class="p">(</span><span class="err">`</span><span class="n">instrucao</span> <span class="n">esperada</span><span class="err">`</span><span class="p">)</span>
</span><span id="__span-4-111"><a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a>    <span class="kd">local</span> <span class="n">else_body</span> <span class="o">=</span> <span class="kr">if</span> <span class="n">consumeWord</span><span class="p">(</span><span class="s1">&#39;else&#39;</span><span class="p">)</span> <span class="kr">then</span> <span class="n">parse_body</span><span class="p">()</span> <span class="ow">or</span> <span class="n">parsing_error</span><span class="p">(</span><span class="err">`</span><span class="n">instrucao</span> <span class="n">esperada</span><span class="err">`</span><span class="p">)</span> <span class="kr">else</span> <span class="kc">nil</span>
</span><span id="__span-4-112"><a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a>
</span><span id="__span-4-113"><a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a>    <span class="kr">return</span> <span class="p">{</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;if&#39;</span><span class="p">,</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">cond</span><span class="p">,</span> <span class="n">then_body</span> <span class="o">=</span> <span class="n">then_body</span><span class="p">,</span> <span class="n">else_body</span> <span class="o">=</span> <span class="n">else_body</span> <span class="p">}</span>
</span><span id="__span-4-114"><a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a><span class="kr">end</span>
</span><span id="__span-4-115"><a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>
</span><span id="__span-4-116"><a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">parse_stat</span><span class="p">():</span> <span class="n">stat</span><span class="err">?</span>
</span><span id="__span-4-117"><a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a>    <span class="kr">return</span> <span class="n">parse_if</span><span class="p">()</span>
</span><span id="__span-4-118"><a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a>        <span class="ow">or</span> <span class="n">parse_assignment</span><span class="p">()</span> <span class="c1">-- precedencia importante aqui</span>
</span><span id="__span-4-119"><a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a>        <span class="ow">or</span> <span class="n">parse_callment</span><span class="p">()</span>
</span><span id="__span-4-120"><a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a><span class="kr">end</span>
</span><span id="__span-4-121"><a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>
</span><span id="__span-4-122"><a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a><span class="c1">-- block</span>
</span><span id="__span-4-123"><a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">parse_block</span><span class="p">():</span> <span class="n">block</span><span class="err">?</span>
</span><span id="__span-4-124"><a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a>
</span><span id="__span-4-125"><a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a>    <span class="kr">if</span> <span class="ow">not</span> <span class="n">consumeChar</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kr">end</span>
</span><span id="__span-4-126"><a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a>    <span class="kd">local</span> <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-4-127"><a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a>    <span class="kr">repeat</span>
</span><span id="__span-4-128"><a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a>        <span class="kd">local</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">parse_stat</span><span class="p">()</span>
</span><span id="__span-4-129"><a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a>        <span class="kr">if</span> <span class="ow">not</span> <span class="n">stat</span> <span class="kr">then</span> <span class="kr">break</span> <span class="kr">end</span>
</span><span id="__span-4-130"><a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a>
</span><span id="__span-4-131"><a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a>        <span class="nb">table.insert</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">stat</span><span class="p">)</span>
</span><span id="__span-4-132"><a id="__codelineno-4-132" name="__codelineno-4-132" href="#__codelineno-4-132"></a>        <span class="n">consumeChar</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
</span><span id="__span-4-133"><a id="__codelineno-4-133" name="__codelineno-4-133" href="#__codelineno-4-133"></a>    <span class="kr">until</span> <span class="kc">false</span>
</span><span id="__span-4-134"><a id="__codelineno-4-134" name="__codelineno-4-134" href="#__codelineno-4-134"></a>
</span><span id="__span-4-135"><a id="__codelineno-4-135" name="__codelineno-4-135" href="#__codelineno-4-135"></a>    <span class="kd">local</span> <span class="n">_1</span> <span class="o">=</span> <span class="n">consumeChar</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">parsing_error</span><span class="p">(</span><span class="err">`</span><span class="n">token</span> <span class="s1">&#39;}&#39;</span> <span class="n">esperado</span><span class="err">`</span><span class="p">)</span>
</span><span id="__span-4-136"><a id="__codelineno-4-136" name="__codelineno-4-136" href="#__codelineno-4-136"></a>    <span class="kr">return</span> <span class="p">{</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span> <span class="p">}</span>
</span><span id="__span-4-137"><a id="__codelineno-4-137" name="__codelineno-4-137" href="#__codelineno-4-137"></a><span class="kr">end</span>
</span><span id="__span-4-138"><a id="__codelineno-4-138" name="__codelineno-4-138" href="#__codelineno-4-138"></a>
</span><span id="__span-4-139"><a id="__codelineno-4-139" name="__codelineno-4-139" href="#__codelineno-4-139"></a><span class="kd">local</span> <span class="kr">function</span> <span class="nf">parse_simple_block</span><span class="p">():</span> <span class="n">block</span><span class="err">?</span>
</span><span id="__span-4-140"><a id="__codelineno-4-140" name="__codelineno-4-140" href="#__codelineno-4-140"></a>
</span><span id="__span-4-141"><a id="__codelineno-4-141" name="__codelineno-4-141" href="#__codelineno-4-141"></a>    <span class="kd">local</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">parse_stat</span><span class="p">()</span>
</span><span id="__span-4-142"><a id="__codelineno-4-142" name="__codelineno-4-142" href="#__codelineno-4-142"></a>    <span class="kr">if</span> <span class="ow">not</span> <span class="n">stat</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kr">end</span>
</span><span id="__span-4-143"><a id="__codelineno-4-143" name="__codelineno-4-143" href="#__codelineno-4-143"></a>
</span><span id="__span-4-144"><a id="__codelineno-4-144" name="__codelineno-4-144" href="#__codelineno-4-144"></a>    <span class="kr">return</span> <span class="p">{</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span> <span class="n">stat</span> <span class="p">}</span> <span class="p">}</span>
</span><span id="__span-4-145"><a id="__codelineno-4-145" name="__codelineno-4-145" href="#__codelineno-4-145"></a><span class="kr">end</span>
</span><span id="__span-4-146"><a id="__codelineno-4-146" name="__codelineno-4-146" href="#__codelineno-4-146"></a><span class="kr">function</span> <span class="nf">parse_body</span><span class="p">():</span> <span class="n">block</span><span class="err">?</span>
</span><span id="__span-4-147"><a id="__codelineno-4-147" name="__codelineno-4-147" href="#__codelineno-4-147"></a>    <span class="kr">return</span> <span class="n">parse_block</span><span class="p">()</span>
</span><span id="__span-4-148"><a id="__codelineno-4-148" name="__codelineno-4-148" href="#__codelineno-4-148"></a>        <span class="ow">or</span> <span class="n">parse_simple_block</span><span class="p">()</span>
</span><span id="__span-4-149"><a id="__codelineno-4-149" name="__codelineno-4-149" href="#__codelineno-4-149"></a><span class="kr">end</span>
</span></code></pre></div>
Por fim, você pode testar rodando
<div class="language-lua highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">tokenizeAll</span><span class="p">(</span><span class="s">[[{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="s">    set a to 1*2*3 + 4 + 10 + 3^5^7;</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="s">    if a &lt; 4 {</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="s">        print(&quot;a..4&quot;)</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="s">    } else if 6 &lt; a {</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="s">        print(&quot;6..a&quot;)</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="s">    } else {</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="s">        print(&quot;4..a..6&quot;)</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="s">    }</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="s">}]]</span><span class="p">)</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="nb">print</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ast:&#39;</span><span class="p">,</span> <span class="n">parse_block</span><span class="p">())</span>
</span></code></pre></div>
E por hoje é tudo, vale notar vários pontos a serem melhorados nesse tipo de implementação.</p>
<ul>
<li>Primeiro de tudo, parsers são consideravelmente caros, e por isso, boa parte são implementados em linguagens de baixo nível, para um desempenho melhor em arquivos maiores.<ul>
<li>Boa parte da implementação é a forma mais eficiente, embora ainda haja algumas estratégias que podem ser adotadas para melhorar muito mais o desempenho</li>
<li>O TokenStream pode ser transformado em uma espécie de lazy stream (corrente preguiçosa), onde invés de tentar todas as combinações possíveis para cada token do texto, você usa a própria expectativa do parser para começar tentando "lexar" os Tokens corretos primeiro (que será o caso mais comum onde o parser vai agir). Misturando isso com também, ordenar os sub-parsers na ordem mais estatisticamente comum, você pode cortar mais que o dobro de tentativas de lexing inúteis. Não só isso, como tentar lexar na hora de consumir te dá resposta imediata se o token é do tipo esperado, oque elimina para nós uma operação de leitura da propriedade "kind" (micro otimização de grande peso).</li>
<li>Otimizar parsers recursivos com recursão de calda, transformando recursões em meros loops (desde que não exija criar qualquer tipo de stack (oque na prática, teria o mesmo custo de recursão, porém mais cara por estar sendo implementada em luau, invés de internamente, em C)).</li>
<li>Lembrar que micro otimizações vão importar nessas pequenas funções, pois alguma delas poderão ser chamadas milhares de vezes em um único documento</li>
</ul>
</li>
<li>Esse parser simplesmente trava no primeiro erro encontrado, ele ainda não é "ignorante a erros", então se quiser diagnósticos mais detalhados, você deve procurar implementar "recuperação de erro"</li>
<li>Ele exporta muito poucas informações do parsing, como localização de cada token</li>
</ul>
<p>Portanto, é uma implementação apenas para demonstração de conceito, serve apenas para ter uma ideia de onde começar para fazer o seu próprio</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": [], "search": "assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>